name: Deploy Portfolio

on:
    push:
        branches:
            - main
    pull_request:

jobs:
    build:
        name: Build
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "18"
                  cache: "npm"

            - name: Install dependencies
              run: npm install

            - name: Build project
              run: npm run build

            - name: Validate build artifacts
              if: github.event_name == 'pull_request'
              run: |
                  echo "ðŸ” Validating build output..."
                  ls -la dist/
                  test -f dist/index.html || (echo "âŒ Missing index.html" && exit 1)
                  test -d dist/assets || (echo "âŒ Missing assets directory" && exit 1)
                  echo "âœ… Build validation completed successfully!"

            - name: Upload build artifacts
              if: github.event_name == 'push' && github.ref == 'refs/heads/main'
              uses: actions/upload-artifact@v4
              with:
                  name: dist
                  path: dist/
                  retention-days: 1

    deploy:
        name: Deploy to Droplet
        runs-on: ubuntu-latest
        needs: build
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        steps:
            - name: Download build artifacts
              uses: actions/download-artifact@v4
              with:
                  name: dist
                  path: dist/

            - name: Setup SSH
              run: |
                  mkdir -p ~/.ssh
                  echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
                  chmod 600 ~/.ssh/id_rsa
                  ssh-keyscan -H "${{ secrets.DROPLET_HOST }}" >> ~/.ssh/known_hosts

            - name: Create deployment script
              run: |
                  cat > deploy.sh << 'EOF'
                  #!/bin/bash
                  set -e
                  sudo mkdir -p /var/www/portfolio-live
                  sudo chown -R www-data:www-data /var/www/portfolio-live
                  sudo systemctl reload nginx
                  EOF

            - name: Deploy to server
              run: |
                  scp deploy.sh ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_HOST }}:~/
                  rsync -avz --delete --rsync-path="sudo rsync" dist/ ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_HOST }}:/var/www/portfolio-live/
                  ssh ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_HOST }} "chmod +x ~/deploy.sh && ~/deploy.sh && rm ~/deploy.sh"

            - name: Cleanup SSH
              if: always()
              run: rm -rf ~/.ssh/id_rsa
